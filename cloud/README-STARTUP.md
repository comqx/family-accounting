# 家账通云托管服务 - 启动脚本说明

## 概述

本项目新增了智能启动脚本 `start.sh`，用于在 Docker 容器启动时自动处理数据库初始化和应用启动流程。

## 启动脚本功能

### 🚀 自动数据库初始化
- **数据库连接检测**: 自动等待数据库服务就绪，最多等待 30 次（每次 5 秒）
- **表结构创建**: 如果表不存在，自动创建所有必要的数据库表
- **初始数据插入**: 自动插入默认分类和系统配置数据
- **状态验证**: 启动前验证数据库状态

### 🔧 错误处理和重试
- **连接重试**: 数据库连接失败时自动重试
- **错误处理**: 初始化失败时停止启动并显示错误信息
- **信号处理**: 正确处理 Docker 停止信号

### 📊 启动流程
1. **环境检查**: 显示当前环境和配置信息
2. **数据库等待**: 等待数据库服务就绪
3. **数据库初始化**: 创建表和初始数据
4. **状态检查**: 验证数据库状态
5. **应用启动**: 启动 Node.js 应用服务

## 文件结构

```
cloud/
├── start.sh                 # 主启动脚本
├── test-startup.sh          # 启动脚本测试工具
├── Dockerfile               # Docker 镜像构建文件
├── index.js                 # 应用入口文件（已简化）
├── scripts/
│   ├── init-database.js     # 数据库初始化脚本
│   ├── db-manager.js        # 数据库管理工具
│   └── test-db.js           # 数据库测试脚本
├── config/
│   └── database.js          # 数据库配置
└── utils/
    └── database.js          # 数据库工具类
```

## 使用方法

### 1. 直接运行启动脚本
```bash
./start.sh
```

### 2. 通过 npm 脚本运行
```bash
npm run start:with-init
```

### 3. Docker 容器中自动使用
```bash
# 构建镜像
docker build -t family-accounting-cloud .

# 运行容器（自动使用启动脚本）
docker run -p 3000:80 family-accounting-cloud
```

### 4. 使用 Docker Compose
```bash
# 启动完整环境
docker-compose -f docker-compose.dev.yml up -d
```

## 测试启动脚本

### 运行测试
```bash
npm run test:startup
```

### 测试内容
- 检查启动脚本是否存在
- 验证脚本执行权限
- 确认必要文件存在
- 显示可用的 npm 脚本

## 环境变量配置

启动脚本会读取以下环境变量：

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=family_accounting
DB_USER=family_user
DB_PASSWORD=family_pass_2024

# 服务配置
NODE_ENV=production
PORT=80
```

## 启动日志示例

```
==========================================
🏠 家账通云托管服务启动脚本
==========================================
⏳ 等待数据库启动...
🔍 尝试连接数据库 (1/30)...
✅ 数据库已就绪
🔧 开始数据库初始化...
✅ 表 users 已存在，跳过创建
✅ 表 categories 创建成功
✅ 插入 13 个默认分类
✅ 数据库初始化成功
📊 检查数据库状态...
✅ 数据库状态检查完成
🚀 启动应用服务...
📍 服务地址: http://0.0.0.0:80
🔍 健康检查: http://0.0.0.0:80/health
==========================================
```

## 故障排除

### 常见问题

1. **启动脚本权限问题**
   ```bash
   chmod +x start.sh
   ```

2. **数据库连接失败**
   - 检查数据库服务是否启动
   - 验证环境变量配置
   - 确认网络连接

3. **初始化失败**
   - 检查数据库用户权限
   - 查看详细错误日志
   - 确认数据库字符集设置

### 调试模式

可以通过修改启动脚本中的 `set -e` 为 `set -ex` 来启用调试模式，显示详细的执行过程。

## 相关文档

- [快速启动指南](./QUICKSTART.md)
- [数据库初始化指南](./README-DATABASE.md)
- [API 文档](./docs/API.md)

## 更新日志

### v1.0.0
- 新增智能启动脚本 `start.sh`
- 自动数据库初始化和状态检查
- 简化 `index.js` 中的数据库初始化逻辑
- 更新 Dockerfile 使用启动脚本
- 添加启动脚本测试工具 