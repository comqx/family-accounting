# å¾®ä¿¡äº‘æ‰˜ç®¡ä¸“ç”¨ Dockerfile
FROM node:24-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# å®‰è£… pnpm å’Œ curlï¼ˆç”¨äºå¥åº·æ£€æŸ¥ï¼‰
RUN npm install -g pnpm && \
    apt-get update && \
    apt-get install -y curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ package.json å’Œ pnpm-lock.yaml
COPY package.json pnpm-lock.yaml ./

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºé¡¹ç›®
RUN pnpm build:weapp

# åˆ›å»ºè¯ä¹¦ç›®å½•å’Œå…¼å®¹æ€§è„šæœ¬
RUN mkdir -p /app/cert
COPY docker/initenv.sh /app/cert/initenv.sh
RUN chmod +x /app/cert/initenv.sh

# å®‰è£…ç®€å•çš„HTTPæœåŠ¡å™¨
RUN npm install -g http-server

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /app/start.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ å¯åŠ¨å®¶è´¦é€šå°ç¨‹åºæœåŠ¡..."

# æ£€æŸ¥æ„å»ºæ–‡ä»¶
if [ ! -f "dist/app.js" ]; then
    echo "âŒ é”™è¯¯: dist/app.js æ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

if [ ! -f "dist/app.json" ]; then
    echo "âŒ é”™è¯¯: dist/app.json æ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

echo "âœ… æ„å»ºæ–‡ä»¶æ£€æŸ¥é€šè¿‡"

# å¯åŠ¨æœåŠ¡
echo "ğŸŒŸ å¯åŠ¨HTTPæœåŠ¡å™¨åœ¨ç«¯å£8080..."
exec http-server dist -p 8080 -c-1 --cors
EOF

RUN chmod +x /app/start.sh

# è®¾ç½®æ–‡ä»¶æƒé™
RUN chown -R appuser:appuser /app

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£ï¼ˆä½¿ç”¨8080é¿å…æƒé™é—®é¢˜ï¼‰
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:8080/ || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["/app/start.sh"]
